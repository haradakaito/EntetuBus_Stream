<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>バス時刻表</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>バス時刻表</h1>
    <div>
        <label for="from_station">乗車バス停:</label>
        <select id="from_station" name="from_station">
            <option value="0">乗車バス停を選択</option>
        </select>
        <label for="to_station">降車バス停:</label>
        <select id="to_station" name="to_station">
            <option value="0">降車バス停を選択</option>
            <option selected="selected" value="浜松駅">浜松駅</option>
        </select>
        <button id="search-button" onclick="startUpdating()">検索</button>
    </div>

    <div id="retrieval-time" style="margin-top: 20px;"></div>

    <div id="no-bus-message" style="margin-top: 20px; color: red;"></div>

    <table id="bus-schedule">
        <thead>
            <tr>
                <th>到着予定</th>
                <th>現在地</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        let updateInterval;

        async function fetchBusSchedule() {
            const fromStation = document.getElementById("from_station").value;
            const toStation = document.getElementById("to_station").value;
            const url = `http://localhost:8000/latest?from_station=${fromStation}&to_station=${toStation}`;
            const response = await fetch(url);
            const data = await response.json();
            return data;
        }

        async function preprocessedBusTableData(data) {
            const ref_time = data[0]['取得日時'];
            const bus_timetable = data[0]['バス時刻表'];
            var bus_schedule = [];
            for (let i = 0; i < bus_timetable.length; i++) {
                bus_schedule.push([bus_timetable[i]['到着予定'], bus_timetable[i]['現在地']]);
            }
            return {'取得日時': ref_time, 'バス時刻表': bus_schedule};
        }

        // バスの運行状況を表示する
        async function displayBusData() {
            const data = await fetchBusSchedule();
            if (data.length === 0 || !data[0]['バス時刻表'].length) {
                document.getElementById("no-bus-message").textContent = "運行中のバスが見つかりませんでした";
                document.getElementById("retrieval-time").textContent = '';
                document.querySelector("#bus-schedule tbody").innerHTML = '';
                return;
            }
            const prepro_data = await preprocessedBusTableData(data);
            document.getElementById("retrieval-time").textContent = `取得日時: ${prepro_data['取得日時']}`;
            document.getElementById("no-bus-message").textContent = '';
            const tbody = document.querySelector("#bus-schedule tbody");
            tbody.innerHTML = ''; // 既存の行をクリア
            for (let i = 0; i < prepro_data['バス時刻表'].length; i++) {
                const row = document.createElement("tr");
                const arrivalCell = document.createElement("td");
                const locationCell = document.createElement("td");
                arrivalCell.textContent = prepro_data['バス時刻表'][i][0];
                locationCell.textContent = prepro_data['バス時刻表'][i][1];
                row.appendChild(arrivalCell);
                row.appendChild(locationCell);
                tbody.appendChild(row);
            }
        }

        function startUpdating() {
            displayBusData();
            updateInterval = setInterval(displayBusData, 60000);
        }

        async function fetchBusStop(erea) {
            const url = `http://localhost:8000/busstop?erea=${erea}`;
            const response = await fetch(url);
            const data = await response.json();
            return data;
        }

        async function preprocessedBusStopData(data) {
            return data[0];
        }

        // 乗車バス停の選択肢を追加
        async function addOption() {
            const erea_list = ['布橋', '城北'];
            for (let i = 0; i < erea_list.length; i++) {
                let data = await fetchBusStop(erea_list[i]);
                data = await preprocessedBusStopData(data);
                var select = document.getElementById('from_station');
                for (let j = 0; j < data['バス停'].length; j++) {
                    var option = document.createElement('option');
                    option.setAttribute('value', data['バス停'][j]);
                    option.textContent = data['バス停'][j];
                    select.appendChild(option);
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            addOption();
        });
    </script>
</body>
</html>